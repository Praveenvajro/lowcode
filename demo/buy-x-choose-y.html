<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Buy X & Choose Y</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
            crossorigin="anonymous"
        />
        <script src="./vajro-sdk.js"></script>
        <style>
            .height {
                height: 300px;
                max-width: 300px;
            }

            .img-width {
                min-height: 250px;
                width: 200px;
            }

            .capitalize {
                text-transform: capitalize;
                text-align: center;
            }
            #slider {
                width: 100%;
                overflow-x: auto;
            }
            .heading {
                padding: 15px;
            }
            .slider-height {
                height: 350px;
            }
            .parent-height {
                height: 72px;
            }
            .default-height {
                height: 0;
            }
        </style>
    </head>
    <body>
        <div class="container-fluid default-height" id="parent">
            <h3 class="heading">Please choose one of the free product</h3>
            <div class="row flex-nowrap" id="slider"></div>
        </div>
        <script>
            const FreeProductMapping = {
                6741457207487: [
                    {
                        productId: '6928843636927',
                        variantId: '40574334304447',
                        lineItemType: 'READONLY'
                    },
                    {
                        productId: '6733619167423',
                        variantId: '39990425288895',
                        lineItemType: 'READONLY'
                    }
                ],
                6928830267583: [
                    {
                        productId: '6750261739711',
                        variantId: '41722470400191',
                        lineItemType: 'READONLY'
                    }
                ]
            };

            const storeURL = 'https://praveenn-vjro.myshopify.com';

            const state = {};
            const slider = document.getElementById('slider');
            let subscribedProducts = Object.keys(FreeProductMapping);

            function handleAddProduct(productId) {
                let productInfo = state.productDetails[productId];
                if (!productInfo.quantity) {
                    productInfo.quantity = 1;
                }
                if (!productInfo.customAttributes) {
                    productInfo.customAttributes = {};
                }
                if (!productInfo.lineItemType) {
                    productInfo.lineItemType = 'READONLY';
                }
                VajroSDK.addLineItemToCart(
                    productInfo.productId,
                    productInfo.variantId,
                    productInfo.quantity,
                    productInfo.customAttributes,
                    productInfo.lineItemType
                ).then(({ lineItem }) => {
                    let { lineItemHandle } = lineItem;
                    Object.keys(state.productDetails).forEach((id) => {
                        if (state.productDetails[id]) {
                            if (id === productId) {
                                state.productDetails[id].inCart = true;
                                state.productDetails[id].lineItemHandle =
                                    lineItemHandle;
                            } else {
                                state.productDetails[id].disabled = true;
                                state.productDetails[id].inCart = false;
                            }
                        }
                    });
                    renderProductSlider();
                });
            }

            function handleRemoveProduct(productId) {
                let productInfo = state.productDetails[productId];
                VajroSDK.removeLineItemFromCart(
                    productInfo.lineItemHandle,
                    0
                ).then(() => {
                    Object.keys(state.productDetails).forEach((id) => {
                        if (state.productDetails[id]) {
                            if (id === productId) {
                                state.productDetails[id].inCart = false;
                                state.productDetails[id].lineItemHandle = null;
                            } else {
                                state.productDetails[id].disabled = false;
                            }
                        }
                    });
                    renderProductSlider();
                });
            }

            const renderProductSlider = () => {
                slider.innerHTML = '';
                let { productDetails } = state;
                Object.keys(productDetails).forEach((id) => {
                    let {
                        title,
                        image,
                        inCart = false,
                        disabled = false
                    } = productDetails[id];
                    let actionTitle = inCart ? 'Remove Cart' : 'Add Cart';
                    let actionHandle = inCart
                        ? 'handleRemoveProduct'
                        : `handleAddProduct`;

                    let productCard = `
                        <div class="col-lg-2 col-xs-1">
                            <div class="card card-block height">
                                <img
                                    class="card-img-top img-width"
                                    src="${image}"
                                />
                                <h5 class="card-title capitalize">${title}</h5>
                                <button class="btn btn-primary" ${
                                    disabled ? 'disabled' : ''
                                } onclick="${actionHandle}('${id}')">${actionTitle}</button>
                            </div>
                        </div>
                        `;

                    slider.innerHTML += productCard;
                    slider.classList.add('slider-height');
                    const parent = document.getElementById('parent');
                    parent.classList.add('parent-height');
                });
            };

            const productsImages = {
                6928843636927: {
                    image: 'https://cdn.shopify.com/s/files/1/0577/3056/4287/products/4_zu_3_teaser_05.jpg?v=1648808832',
                    title: 'iphone 6s',
                    productId: '6928843636927',
                    variantId: '40574334304447',
                    lineItemType: 'READONLY'
                },
                6733619167423: {
                    image: 'https://cdn.shopify.com/s/files/1/0577/3056/4287/products/bags2.jpg?v=1623325323',
                    title: 'bags',
                    productId: '6733619167423',
                    variantId: '39990425288895',
                    lineItemType: 'READONLY'
                },
                6750261739711: {
                    image: 'https://cdn.shopify.com/s/files/1/0577/3056/4287/products/mobile_charger.jpg?v=1624025315',
                    title: 'charger',
                    productId: '6750261739711',
                    productId: '6750261739711',
                    variantId: '41722470400191',
                    lineItemType: 'READONLY'
                },
                69288436369271: {
                    image: 'https://cdn.shopify.com/s/files/1/0577/3056/4287/products/4_zu_3_teaser_05.jpg?v=1648808832',
                    title: 'iphone 6s',
                    productId: '6928843636927',
                    variantId: '40574334304447',
                    lineItemType: 'READONLY'
                },
                67336191674233: {
                    image: 'https://cdn.shopify.com/s/files/1/0577/3056/4287/products/bags2.jpg?v=1623325323',
                    title: 'bags',
                    productId: '6733619167423',
                    variantId: '39990425288895',
                    lineItemType: 'READONLY'
                },
                67502617397111: {
                    image: 'https://cdn.shopify.com/s/files/1/0577/3056/4287/products/mobile_charger.jpg?v=1624025315',
                    title: 'charger',
                    productId: '6750261739711',
                    productId: '6750261739711',
                    variantId: '41722470400191',
                    lineItemType: 'READONLY'
                },
                69288436369272: {
                    image: 'https://cdn.shopify.com/s/files/1/0577/3056/4287/products/4_zu_3_teaser_05.jpg?v=1648808832',
                    title: 'iphone 6s',
                    productId: '6928843636927',
                    variantId: '40574334304447',
                    lineItemType: 'READONLY'
                },
                67336191674232: {
                    image: 'https://cdn.shopify.com/s/files/1/0577/3056/4287/products/bags2.jpg?v=1623325323',
                    title: 'bags',
                    productId: '6733619167423',
                    variantId: '39990425288895',
                    lineItemType: 'READONLY'
                },
                67502617397112: {
                    image: 'https://cdn.shopify.com/s/files/1/0577/3056/4287/products/mobile_charger.jpg?v=1624025315',
                    title: 'charger',
                    productId: '6750261739711',
                    productId: '6750261739711',
                    variantId: '41722470400191',
                    lineItemType: 'READONLY'
                },
                69288436369273: {
                    image: 'https://cdn.shopify.com/s/files/1/0577/3056/4287/products/4_zu_3_teaser_05.jpg?v=1648808832',
                    title: 'iphone 6s',
                    productId: '6928843636927',
                    variantId: '40574334304447',
                    lineItemType: 'READONLY'
                },
                673361916742323: {
                    image: 'https://cdn.shopify.com/s/files/1/0577/3056/4287/products/bags2.jpg?v=1623325323',
                    title: 'bags',
                    productId: '6733619167423',
                    variantId: '39990425288895',
                    lineItemType: 'READONLY'
                },
                67502617397113: {
                    image: 'https://cdn.shopify.com/s/files/1/0577/3056/4287/products/mobile_charger.jpg?v=1624025315',
                    title: 'charger',
                    productId: '6750261739711',
                    productId: '6750261739711',
                    variantId: '41722470400191',
                    lineItemType: 'READONLY'
                }
            };

            state.productDetails = productsImages;
            renderProductSlider();

            const fetchProductDetails = (productId) => {
                return Promise.resolve(productsImages[productId]);
                // let apiURL = `${storeURL}/admin/products/${productId}.json`;
                // return new Promise((resolve, reject) => {
                //     fetch(apiURL).then((res) => {
                //         res.json().then(({ product: { images } }) => {
                //             let { src: image, title } = images[0];
                //             resolve({ productId, image, title });
                //         });
                //     });
                // });
            };

            const handleLineItemAdded = (appContext, lineItem) => {
                let { productId } = lineItem;

                if (subscribedProducts.includes(productId)) {
                    let subProductsToChoose = FreeProductMapping[productId];
                    if (subProductsToChoose) {
                        let promises = [];
                        subProductsToChoose.forEach((subProduct) => {
                            let promise = fetchProductDetails(
                                subProduct.productId
                            );
                            promises.push(promise);
                        });
                        Promise.all(promises)
                            .then((res) => {
                                let products = {};
                                res.forEach(
                                    ({
                                        productId,
                                        image,
                                        title,
                                        variantId
                                    }) => {
                                        products[productId] = {
                                            image,
                                            title,
                                            inCart: false,
                                            disabled: false,
                                            productId,
                                            variantId
                                        };
                                    }
                                );
                                state.productDetails = products;
                                renderProductSlider();
                            })
                            .catch((err) => {
                                alert(JSON.stringify(err));
                            });
                    }
                }
            };

            const handleLineItemUpdated = (appContext, lineItem) => {
                let { productId } = lineItem;
                if (subscribedProducts.includes(productId)) {
                    let subProductsToChoose = FreeProductMapping[productId];
                    if (subProductsToChoose) {
                        let promises = [];
                        subProductsToChoose.forEach((subProduct) => {
                            let promise = fetchProductDetails(
                                subProduct.productId
                            );
                            promises.push(promise);
                        });
                        Promise.all(promises)
                            .then((res) => {
                                let products = {};
                                res.forEach(
                                    ({
                                        productId,
                                        image,
                                        title,
                                        variantId
                                    }) => {
                                        products[productId] = {
                                            image,
                                            title,
                                            inCart: false,
                                            disabled: false,
                                            variantId,
                                            productId
                                        };
                                    }
                                );
                                state.productDetails = products;
                                renderProductSlider();
                            })
                            .catch((err) => {
                                alert(JSON.stringify(err));
                            });
                    }
                }
            };

            VajroSDK.subscribe(
                VajroSDK.Triggers.LINE_ITEM_ADDED_TO_CART,
                handleLineItemAdded
            );

            VajroSDK.subscribe(
                VajroSDK.Triggers.LINE_ITEM_UPDATED,
                handleLineItemUpdated
            );
        </script>
    </body>
</html>
