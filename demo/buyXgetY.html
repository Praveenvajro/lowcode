<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Buy X & Get Y</title>
        <script src="./vajro-sdk.js"></script>
    </head>
    <body>
        <div id="output"></div>
        <script>
            const output = document.getElementById('output');
            const FreeProductMapping = {
                // 6741457207487: [
                //     {
                //         productId: '6928843636927',
                //         variantId: '40574334304447',
                //         lineItemType: 'READONLY'
                //     },
                //     {
                //         productId: '6733619167423',
                //         variantId: '41722470400191',
                //         lineItemType: 'READONLY'
                //     }
                // ],
                6928830267583: [
                    {
                        productId: '6750261739711',
                        variantId: '41722470400191',
                        lineItemType: 'READONLY'
                    }
                ]
            };

            let subscribedProducts = Object.keys(FreeProductMapping);

            const addLineItem = (productInfo) => {
                if (!productInfo.quantity) {
                    productInfo.quantity = 1;
                }
                if (!productInfo.customAttributes) {
                    productInfo.customAttributes = {};
                }
                return new Promise((resolve, reject) => {
                    VajroSDK.addLineItemToCart(
                        productInfo.productId,
                        productInfo.variantId,
                        productInfo.quantity,
                        productInfo.customAttributes,
                        productInfo.lineItemType
                    )
                        .then(resolve)
                        .catch(reject);
                });
            };

            const removeLineItem = (lineItemHandle, quantity) => {
                return new Promise((resolve, reject) => {
                    VajroSDK.removeLineItemFromCart(lineItemHandle, quantity)
                        .then(resolve)
                        .catch(reject);
                });
            };

            const handleLineItemAdded = (appContext, lineItem) => {
                let { productId } = lineItem;
                if (subscribedProducts.includes(productId)) {
                    let subProductsToAdd = FreeProductMapping[productId];
                    if (subProductsToAdd) {
                        let promises = [];
                        subProductsToAdd.forEach((subProduct) => {
                            let promise = addLineItem(subProduct);
                            promises.push(promise);
                        });
                        Promise.all(promises)
                            .then(() => {
                                alert('Sub products added successfully');
                            })
                            .catch((err) => {
                                alert(JSON.stringify(err));
                            });
                    }
                }
            };

            const handleLineItemUpdated = (
                appContext,
                updateType,
                lineItem
            ) => {
                let { productId, quantity } = lineItem;
                output.innerHTML += `<div>${updateType}</div>`;
                if (subscribedProducts.includes(productId)) {
                    let subProductsToProcess = FreeProductMapping[productId];
                    if (subProductsToProcess) {
                        let promises = [];
                        subProductsToProcess.forEach((subProduct) => {
                            let promise;
                            if (updateType === 'Increment') {
                                output.innerHTML += `<div>Increment: ${JSON.stringify(
                                    Object.assign({}, subProduct, {
                                        quantity
                                    })
                                )}</div>`;

                                promise = addLineItem(
                                    Object.assign({}, subProduct, {
                                        quantity
                                    })
                                );
                            } else if (
                                updateType === 'Decrement' ||
                                updateType === 'Delete'
                            ) {
                                let {
                                    cartLineItems: { lineItems }
                                } = appContext;
                                let subLineItemHandle, subId;
                                for (let {
                                    lineItemHandle,
                                    productId: id
                                } of lineItems) {
                                    if (id === productId) {
                                        subLineItemHandle = lineItemHandle;
                                        subId = id;
                                        break;
                                    }
                                }
                                output.innerHTML += `<div>subLineItemHandle: ${subLineItemHandle}, ${subId}</div>`;
                                if (updateType === 'Delete') {
                                    promise = removeLineItem(
                                        subLineItemHandle,
                                        0
                                    );
                                } else {
                                    promise = removeLineItem(
                                        subLineItemHandle,
                                        quantity
                                    );
                                }
                            }
                            promises.push(promise);
                        });
                        Promise.all(promises)
                            .then((res) => {
                                alert(JSON.stringify(res));
                            })
                            .catch((err) => {
                                alert(JSON.stringify(err));
                            });
                    }
                }
            };

            VajroSDK.subscribe(
                VajroSDK.Triggers.LINE_ITEM_ADDED_TO_CART,
                handleLineItemAdded
            );

            VajroSDK.subscribe(
                VajroSDK.Triggers.LINE_ITEM_UPDATED,
                handleLineItemUpdated
            );
        </script>
    </body>
</html>
